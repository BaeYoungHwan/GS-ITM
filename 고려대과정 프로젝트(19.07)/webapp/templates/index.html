<!DOCTYPE html>

<html>
<head>
	<title>tree</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2f9Ov2vdnIuQH_v6TueJW6vijU8rtVfo&callback=initMap" async defer></script>
    <script src="{{ url_for('static', filename='js/d3.v4.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/locations_able.js') }}"></script>
    <script src="{{ url_for('static', filename='js/locations_count.js') }}"></script>
    <script src="{{ url_for('static', filename='js/treeList.js') }}"></script>
    <script src="{{ url_for('static', filename='js/value_color.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">


        google.load('visualization', '1.0', {'packages':['corechart']});
        google.setOnLoadCallback(drawChart);

        var sites = readTotalSites();
        var values = readValueDifference();
        var valueColors = readValueColor();
        var treeList = readTotalTrees();
        var transparent = false;
        var recs = new Array();
        var dataTxt = ["|Building","| 은행나무 ","| 버즘나무 ","| 느티나무 ","| 벚나무 ","| 소나무 ","| 단풍나무 ","| 회화나무 ","| 메타세쿼이아 ","| 중국단풍 ","| 기 타 |"];

        function Data(lat, lng) {
            this.lat = lat;
            this.lng = lng;
        }

        function Rec(coordi, value, indexN) {
            this.coordi = coordi;
            this.value = value;
            this.on = false;
            this.polygon;
            this.temp;
            this.tempValue;
            this.indexNum = indexN;
        }

        PutData();
/////


////////////////////////



        var setboundss ={
            north:37.583997,
            south:37.441710,
            west:126.803939,
            east:127.021840,
        };



        function initialize() {
            // var styledMap = new google.maps.StyledMapType(styles, { name: "Styled Map" });
            // Google Map
            var mapOptions = {
                center: new google.maps.LatLng(37.519496, 126.910957),
                zoom: 13.5,
                disableDoubleClickZoom: true,
                restriction: {
                    latLngBounds: setboundss,
                    strictBounds: true,
          },
            };

            map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
            // google.map setting 고정
            // map.mapTypes.set('map_style', styledMap);
            // map.setMapTypeId('map_style');

            DrawBackground();

            for (var i = 0 ; i < recs.length ; i++) drawPolygon(recs[i]);



        } //initialize()



        function PutData() {

            var cnt = 0;

            for (var i = 0; i < sites.length; i++) {

                if (sites[i].length != 0) {

                    var coordiTemp = new Array();
                    for (var j = 0 ; j < sites[i].length ; j++) {
                        coordiTemp.push(new Data(sites[i][j][1], sites[i][j][0]));
                    }

                    var valueTemp = new Array();
                    for (var j = 0 ; j < values[i].length ; j++) {
                        valueTemp.push(values[i][j]);
                    }

                    recs.push(new Rec(coordiTemp, valueTemp, cnt ));
                    cnt++;
                }
            }
        }

        function DrawBackground() {
            var backRect = new Array();
            var backCoord = [[37.441710,126.803939],[37.441710,127.021840],[37.583997,127.021840],[37.583997,126.803939],[37.441710,126.803939]];
            for (var i = 0 ; i < backCoord.length ; i++) {
                backRect.push(new google.maps.LatLng(backCoord[i][0],backCoord[i][1]));
            }

            var polygons = {
                path: backRect,
                strokeColor: "#ffffff",
                strokeOpacity: 1,
                strokeWeight: 0,
                fillColor: "#ffffff",
                fillOpacity: 0.8,
                url: "/127.0.0.1:5000/sector",
                zIndex: 100
            };

            // 하얀색 도화지 그리는 함수
            var background = new google.maps.Polygon(polygons);
            background.setMap(map);
        }

    function arrSum(arr){
  return arr.reduce(function(a,b){
    return a + b
  }, 0);
}
        var infoWindow = new google.maps.InfoWindow({ content: ''});


        function drawChart(datum) {
            var tb = arrSum(datum.value.slice(1));

                // 탄소저감 9470, 미세먼지 12100, 에너지절감 28600, 배수효과 3120 -- 연간기준(단위:원)
                var sec_benefit = [(tb*9470),(tb*12100),(tb*28600),(tb*3120)];

        var marker = datum.polygon;
        // Create the data table.
        var data = new google.visualization.DataTable();
        data.addColumn('string', '');
        data.addColumn('number', '단위:원');
        data.addRows([
          ['탄소절감', sec_benefit[0]],
          ['미세먼지', sec_benefit[1]],
          ['온도조절', sec_benefit[2]],
          ['배수효과', sec_benefit[3]],
            ['',200000]
        ]);

        // Set chart options
        var options = {'title':'해당 구역 이득산출',
                       'width':430,
                       'height':200,
            'scales': {
        'xAxes': [{
            barPercentage: 0.5,
            barThickness: 6,
            maxBarThickness: 8,
            minBarLength: 2,
            gridLines: {
                offsetGridLines: true
            }
        }]
    }
        };

        var node        = document.createElement('div'),
            chart       = new google.visualization.BarChart(node);

            chart.draw(data, options);
            infoWindow.setContent(node);
            infoWindow.setPosition(new google.maps.LatLng((datum.coordi[0].lat + datum.coordi[2].lat) / 2, (datum.coordi[0].lng + datum.coordi[2].lng) / 2));
            infoWindow.open(marker.getMap(),marker);
      }






        function drawPolygon(datum) {

            var polygonCoords = new Array();

            for (var i = 0 ; i < datum.coordi.length ; i++) {
                polygonCoords.push(new google.maps.LatLng(datum.coordi[i].lat, datum.coordi[i].lng));
            }

            var stColor = "#f6fdf6";
            // 색리스트
            var listColors = ["#D21919","#ffffff","#4fd24f"];
            var color_val = arrSum(datum.value);
            if (color_val<0) {var  flColor = "#b2b0b0";} else if (color_val==0) {var  flColor = "#04eafd";} else{var  flColor = "#A3FD04";}

            var  fillOpa = 1;

            var polygons = {
                path: polygonCoords,
                strokeColor: stColor,
                strokeOpacity: 1,
                strokeWeight: 1,
                fillColor: flColor,
                fillOpacity: fillOpa,
                zIndex : 200,
                map :map,
                url: "/127.0.0.1:5000/aa",

            };

            datum.polygon = new google.maps.Polygon(polygons);



            //tooltips
            // infoWindow 이놈이 격자안에 데이터 넣는 놈
            var contentText = "<table border=\"0\"><tr>" + datum.indexNum+ "</tr><tr>";
            for (var i = 1 ; i < dataTxt.length ; i++) contentText += "<td>"+ dataTxt[i] + "</td>"

            contentText += "</tr><tr>";
            for (var i = 1 ; i < datum.value.length ; i++) contentText += "<td style=text-align:center>"+ "|  "+ (datum.value[i]) + "  |"+ "</td>";
            contentText += "</tr></table>";

            google.maps.event.addListener(datum.polygon, 'click', function () {
                infoWindow.close();

                infoWindow.setContent(contentText);
                infoWindow.setPosition(new google.maps.LatLng((datum.coordi[0].lat + datum.coordi[2].lat) / 2, (datum.coordi[0].lng + datum.coordi[2].lng) / 2));
                infoWindow.open(map,datum.polygon);
            });






            google.maps.event.addListener(datum.polygon, 'rightclick', function () {

                infoWindow.close();
                drawChart(datum);

            });
            // 연동
            google.maps.event.addListener(datum.polygon, 'dblclick', function () {
             localStorage.setItem("indexNum", datum.indexNum);
             window.location.href = 'sector';

            });
        }




    </script>

    <style>
        html, body {
            height: 80%;
            margin: 0;
            padding: 0;
        }

        svg {

            position: absolute;
            top: 60px;
            left: 100px;
            z-index: 5;

        }
nav{
    border-bottom: 2px solid #000;
}
        /* 화면 크기 조절하는 부분 */
        #main_area {
            height: 100%;
            width: 100%;
        }

            #main_area > #map_canvas {
                position : absolute;
                right : 250px;
                left : 0;
                display : inline-block;
                height: 90%;

            }


        @media print {
            html, body {
                height: auto;
            }

            #map-canvas, #map_canvas {
                height: 600px;
            }
        }


        svg text {
            font-family: Arial;
            fill : #000000;
            font-weight : bold;

        }

        svg path {
            stroke: #fff;
        }



        ul.group >li {
            font-family: '맑은 고딕', Arial;
            font-weight : bold;
            font-size : 10px;
            text-align :center;
            line-height : 13px;
            display :block;
            height : 13px;
            width : 109px;
            padding : 5px 5px 5px 5px;
            margin : 2px 0px 2px 0px;
        }

        ul.group >  #unselected {
            background-color: #f2f2f2;
            color : black;
        }

    </style>

</head>

<body onload="initialize()">
<!-- As a link -->
    <nav class="navbar navbar-light" style="background-color: #ffffff;">
      <a style="color: #ffffff"  class="navbar-brand" href="#">

          <img src="{{ url_for('static', filename='icon/tle.png') }}" width="200" height="50" class="d-inline-block align-top" alt="">

      </a>
    </nav>
    <div id="main_area" >
        <section id="map_canvas" ></section>
        <canvas id="pieChart" style="max-width: 250px; display: block; height: 300px; width: 250px; position: absolute; top: 100px; right: 0;"></canvas>
        <canvas id="myChart" style="max-width: 250px; display: block; height: 300px; width: 250px;  position: absolute; top: 450px; right: 0;"></canvas>
        <input class="btn btn-danger" type="button" value="검색" style=" position: absolute; top: 750px; right: 20px;">
        <input class="btn btn-success" type="button" value="추천" style=" position: absolute; top: 750px; right: 80px;">
        <input class="btn btn-primary" role = 'button' type="button" value="보고서" onclick="window.location.href='repo'" style=" position: absolute; top: 750px; right: 140px;">
        <script>





            var ctxP = document.getElementById("pieChart").getContext('2d');
            var myPieChart = new Chart(ctxP, {
              type: 'pie',
              data: {
                labels: ["은행나무","버즘나무","느티나무","벚나무","소나무","단풍나무","회화나무","메타세쿼이아","중국단풍","기 타"],
                datasets: [{
                  data: [10319, 8068, 3871, 2884, 1097, 1062, 506, 382, 380, 2168],
                  backgroundColor: ["#F7464A", "#46BFBD", "#FDB45C", "#F9F506", "#15E8EF", "#8258FA" , "#04B404" , "#6E105A" , "#8B1517", ,"#C3C033"],
                  hoverBackgroundColor: ["#F7464A", "#46BFBD", "#FDB45C", "#F9F506", "#15E8EF", "#8258FA" , "#04B404" , "#6E105A" , "#8B1517", ,"#C3C033"]
                }]
              },
              options: {
                responsive: true
              }
            });
        </script>
        <script>
            var ctx = document.getElementById("myChart").getContext('2d');
            var myChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: ["미세먼지", "탄소저감", "온도조절", "배수효과"],
                datasets: [{
                  label: '베네핏 결과',
                  data: [12, 19, 3, 5, 2, 3],
                  backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                  ],
                  borderColor: [
                    'rgba(255,99,132,1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                  ],
                  borderWidth: 1
                }]
              },
              options: {
                scales: {
                  yAxes: [{
                    ticks: {
                      beginAtZero: true
                    }
                  }]
                }
              }
            });
    </script>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>